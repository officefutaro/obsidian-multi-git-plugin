# Git Repository Manager 機能仕様書 v1.0.0
**作成日**: 2024年10月28日  
**バージョン**: 1.0.0  
**最終更新**: 2024年10月28日 23:30

---

## 🎯 概要

Obsidian Multi-Git Plugin は、Obsidian Vault内およびその関連ディレクトリのGitリポジトリを一元管理するプラグインです。

---

## 📋 機能仕様

### 1. **リポジトリ自動検出**

#### 検出順序と条件
```
検出優先順位：
1️⃣ Parent Directory (親ディレクトリ)
   ├─ 条件: Vault親ディレクトリに.gitが存在
   └─ 表示名: "Parent (Claude Code)"

2️⃣ Vault Directory (Vaultディレクトリ)
   ├─ 条件: Vault自体に.gitが存在
   └─ 表示名: "Vault"

3️⃣ Sub Directories (サブディレクトリ)
   ├─ 条件: 以下のすべてを満たす
   │   ├─ Vaultに.gitが存在しない場合のみ検索
   │   ├─ サブフォルダに独立した.gitが存在
   │   └─ ドットで始まらない通常フォルダ
   └─ 表示名: "Vault/[フォルダ名]"

🔄 特別ケース: Known Sub-repositories
   ├─ 条件: Vaultに.gitがある場合でも以下をチェック
   │   ├─ 'Novels', 'Projects', 'Plugins'フォルダ
   │   └─ 独立した.gitディレクトリを持つ
   └─ 表示名: "Vault/[フォルダ名]"
```

### 2. **表示要素**

#### 各リポジトリに表示される情報
- **リポジトリ名**: Parent/Vault/Vault/{name}
- **完全パス**: 横スクロール対応で全パス表示
- **ブランチ情報**: 現在のブランチ名
- **同期状況**: Ahead(↑) / Behind(↓) 表示
- **変更状況**: Modified/Added/Deleted 数

### 3. **操作機能**

#### 個別操作
- **Commit**: 手動メッセージ入力 → git add -A → git commit
- **Push**: git push 実行
- **Pull**: git pull 実行

#### 一括操作
- **Commit All**: 全リポジトリに同じメッセージでcommit
- **Push All**: 全リポジトリでpush実行
- **Pull All**: 全リポジトリでpull実行

---

## 🧪 テストケース

### ケース1: 単一Vaultリポジトリ
```
構造:
Vault/
└── .git/

期待結果:
- "Vault" のみ表示
- サブディレクトリは検索されない
```

### ケース2: Vaultなし、サブリポジトリあり
```
構造:
Vault/
├── Novels/
│   └── .git/
└── Projects/
    └── .git/

期待結果:
- "Vault/Novels" 表示
- "Vault/Projects" 表示
```

### ケース3: Vault + サブリポジトリ (特別ケース)
```
構造:
Vault/
├── .git/
└── Novels/
    └── .git/

期待結果:
- "Vault" 表示
- "Vault/Novels" 表示 (Known Sub-repo)
```

### ケース4: 親リポジトリあり
```
構造:
Parent/
├── .git/
└── Vault/
    └── .git/

期待結果:
- "Parent (Claude Code)" 表示
- "Vault" 表示
```

### ケース5: 隠しフォルダ除外
```
構造:
Vault/
├── .git/
├── .obsidian/
├── .trash/
└── .claude/

期待結果:
- "Vault" のみ表示
- ドットフォルダは除外
```

---

## 🎨 UI仕様

### モーダルサイズ
- **幅**: 900px (最大90vw)
- **高さ**: 最大80vh (スクロール対応)

### パス表示
- **完全パス表示**: 必須
- **横スクロール**: 長いパス対応
- **ツールチップ**: ホバーで全パス表示

### ボタン配置
```
┌─────────────────────────────────────┐
│  Git Repository Manager    🔄 Refresh │
├─────────────────────────────────────┤
│ 📝 Commit All | ⬆️ Push All | ⬇️ Pull All │
├─────────────────────────────────────┤
│ Repository Name                      │
│ ┌─ Full Path ────────────────────┐  │
│ │ F:\Long\Path\Here...           │  │
│ └────────────────────────────────┘  │
│ 🌿 master ↑2 ↓1                     │
│ 📝 2 modified ➕ 4 added            │
│ [📝 Commit] [⬆️ Push] [⬇️ Pull]      │
└─────────────────────────────────────┘
```

---

## 🔧 実装詳細

### 主要関数

#### `detectRepositories()`
1. 親ディレクトリをチェック
2. Vaultディレクトリをチェック
3. Vaultが非Git → サブディレクトリをスキャン
4. Vaultが Git → Known Sub-reposをチェック

#### `isGitRepository(dirPath)`
```javascript
git rev-parse --git-dir
```
でGitリポジトリ判定

#### `getGitStatus(repoPath)`
並列実行:
- `git status --porcelain`
- `git branch --show-current`
- `git rev-list --left-right --count HEAD...@{upstream}`

---

## 🚫 制限事項

### 除外対象
- **ドットフォルダ**: `.git`, `.obsidian`, `.trash`, `.claude`
- **Gitサブモジュール**: 現在未対応
- **ベアリポジトリ**: 対応範囲外

### セキュリティ
- **パス検証**: ディレクトリトラバーサル対策済み
- **コマンド実行**: child_processで制限実行

---

## 📊 パフォーマンス

### 応答時間目標
- **リポジトリ検出**: < 2秒
- **ステータス取得**: < 1秒
- **UI描画**: < 500ms

### 制限
- **最大リポジトリ数**: 実用上無制限
- **パス長**: OS制限に準拠

---

## 🔄 更新履歴

| バージョン | 日付 | 変更内容 |
|-----------|------|---------|
| 1.0.0 | 2024-10-28 | 機能仕様確定、Known Sub-repos対応 |
| 0.9.6 | 2024-10-28 | 重複検出バグ修正 |
| 0.9.5 | 2024-10-28 | フルパス表示対応 |
| 0.9.4 | 2024-10-28 | サブディレクトリ検出追加 |

---

## ✅ 品質保証

### 検証項目
- [ ] 全テストケースでの動作確認
- [ ] UI表示の完全性
- [ ] パフォーマンス要件
- [ ] エラーハンドリング

### 承認
- **仕様策定**: futaro + Claude Code
- **実装**: Claude Code
- **テスト**: 実装後実施予定

---

**文書管理**:  
この仕様書は実装とテストの基準として使用され、機能追加時には必ず更新されます。